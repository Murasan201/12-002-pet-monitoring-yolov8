# ペット見守りシステム 要件定義書

## 1. 概要
本システムは、ペット（犬・猫）を自宅で見守るためのシステムである。カメラ映像により対象を検出し、自動的にカメラの向きを調整することで常に画角中央にペットを収めることを目的とする。

## 2. ハードウェア構成
- **Raspberry Pi 5**（推奨）または Raspberry Pi 4  
- **Camera Module v3** または互換 USB カメラ  
- **PCA9685 16-Channel Servo Driver**  
- **SG90 サーボモーター ×2**（パン・チルト制御用）  
- **Pan-Tilt ブラケット**（カメラおよびサーボ固定用）  
- **Adafruit製 PCA9685 サーボドライバHAT**（製品ID: 2327）  

## 3. ソフトウェア構成
- OS: Raspberry Pi OS (64-bit)  
- プログラミング言語: Python  
- 使用ライブラリ:
  - OpenCV（カメラ画像処理）
  - ultralytics YOLOv8（物体検出）
  - Adafruit_PCA9685（サーボ制御ライブラリ）
- サーボ制御プログラムは以下のリポジトリを利用:  
  https://github.com/Murasan201/12-001-pan-tilt-pet-tracker

## 3.1 モジュール構成（Python）
本プロジェクトは**モジュール分割**して実装する。メインプログラムから各モジュールを呼び出す構成とする。

- **`camera_tracker.py`（カメラ画角制御＋撮影）**  
  - 機能: パン・チルトの初期化、全域スキャン、P制御追跡、静止画撮影（3枚、縮小＆JPEG圧縮）  
  - 主な公開関数（例）：
    - `scan_and_track()`：可動域全体のステップ走査と対象検出。検出時に追跡へ移行。
    - `capture_images(count=3, long_edge=800, jpeg_quality=70)`：指定パラメータで画像を撮影・保存し、ファイルパス配列を返す。
  - I/O: 画像ファイル（保存先ディレクトリ）、検出・追跡の状態/座標情報（必要に応じて返却）

- **`slack_uploader.py`（Slackアップロード）**  
  - 機能: Slack への画像送信（方式A: Web API 直接アップロード／方式B: 画像URL参照メッセージ）
  - 主な公開関数（例）：
    - `upload_files(file_paths: list[str], channel: str, text: str | None = None)`  
      - 方式A（推奨）: `slack_sdk` の `files_upload_v2` でアップロード
      - 方式B: 画像を外部ストレージへ配置し、その **URL** を `chat.postMessage` で投稿
  - I/O: Slack API（トークン/チャンネル）／投稿結果（TSなど）

- **`main.py`（メイン・オーケストレーター）**  
  - 機能: 10分ごとのジョブ実行、エラーハンドリング、ログ出力、設定読み込み  
  - 処理: `camera_tracker.scan_and_track()`→検出ありの場合 `camera_tracker.capture_images()`→`slack_uploader.upload_files()` を順に呼び出す。
  - 設定: `.env`（例: `SLACK_BOT_TOKEN`, `SLACK_CHANNEL`, 保存ディレクトリ、JPEG品質等）

---

## 4. 機能仕様
1. **対象検出機能**  
   - YOLOv8 を用いてカメラ画像から犬または猫を検出する。
   - 検出対象は矩形（バウンディングボックス）で表現される。

2. **追跡機能**  
   - 検出した対象のバウンディングボックスの中心座標を基準に、カメラの画角中央と比較。
   - 水平方向（パン）、垂直方向（チルト）それぞれについて制御量を算出。
   - サーボを駆動して対象が常に中央に来るように調整する。

3. **制御方式**  
   - 簡易 **P制御（比例制御）** を採用する。  
   - 制御量 = 比例ゲイン ×（目標位置と現在位置の誤差）  
   - I（積分）および D（微分）は使用しない（時間刻みの精密性を担保できないため）。
   - サーボ制御の詳細設計については、リポジトリ内の以下のファイルを参照すること:  
     **`raspberry_pi_5_pan_tilt_追跡制御_検討レポート（pca_9685_＋p制御）rev_4.md`**

4. **定期スキャン & 通知**  
   - **10分ごと**に処理を開始する（タイマー/スケジューラ駆動）。
   - スキャン時はサーボの可動域全体をステップ走査し、各位置でフレームを取得して YOLOv8 により対象を検出する。
   - 対象を検出した場合は追跡モードへ移行し、**数秒間**（例: 5〜10秒）中央追尾を継続する。
   - 追跡中に**静止画を3枚**撮影する。

5. **画像保存・サイズ最適化**  
   - 静止画は**安全確認ができる最小限の解像度**へ縮小し（目安: 長辺 640〜800px）、JPEG で**中程度の圧縮**（目安: 品質 60〜80）を行いデータサイズを抑える。
   - ファイル名はタイムスタンプを含め一意に管理し、指定ディレクトリに保存する。

6. **Slack 通知**  
   - 撮影した3枚の静止画を Slack へ通知する。実装方式は以下のいずれかとする：
     - **方式A（推奨）：Slack Web API でのファイルアップロード**  
       - `slack_sdk`（`WebClient` の `files_upload_v2` 等）を用いて、Pi 上で保存した画像ファイルを**直接 Slack にアップロード**する。別サーバーは不要。
     - **方式B：外部ストレージ + Webhook**  
       - 画像を外部ストレージ（例：S3/R2 等、**公開URL**または期限付き署名URL）に保存し、Incoming Webhook または `chat.postMessage` で**画像URLを参照**するメッセージを送信する。
   - ※ Incoming Webhook **単体ではファイルの直接アップロードは不可**のため、アップロードが必要な場合は方式Aを用いる。 想定利用シナリオ
- 飼い主が外出中、Raspberry Pi 上でシステムが稼働し、ペットが移動してもカメラが自動追従。
- 後日、拡張機能として録画やスマホ通知への対応を検討可能。

---
以上の要件を満たすことで、家庭内でペットの見守りを効率的に行えるシステムを実現する。

